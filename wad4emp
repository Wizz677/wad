CREATE TABLE Department (
    DeptNo INT PRIMARY KEY,
    DeptName VARCHAR(50) UNIQUE NOT NULL,
    ManagerSSN INT,
    ManagerStartDate DATE
);

CREATE TABLE Employee (
    SSN INT PRIMARY KEY,
    Name VARCHAR(50),
    Address VARCHAR(100),
    Salary DECIMAL(10,2),
    Sex CHAR(1),
    BirthDate DATE,
    DeptNo INT,
    SupervisorSSN INT,
    FOREIGN KEY (DeptNo) REFERENCES Department(DeptNo),
    FOREIGN KEY (SupervisorSSN) REFERENCES Employee(SSN)
);

ALTER TABLE Department
ADD CONSTRAINT fk_manager
FOREIGN KEY (ManagerSSN)
REFERENCES Employee(SSN);

CREATE TABLE Dept_Location (
    DeptNo INT,
    Location VARCHAR(50),
    PRIMARY KEY (DeptNo, Location),
    FOREIGN KEY (DeptNo) REFERENCES Department(DeptNo)
);

CREATE TABLE Project (
    ProjectNo INT PRIMARY KEY,
    ProjectName VARCHAR(50) UNIQUE,
    Location VARCHAR(50),
    DeptNo INT,
    CompletionDate DATE,
    ProjectAmount DECIMAL(12,2),
    FOREIGN KEY (DeptNo) REFERENCES Department(DeptNo)
);

CREATE TABLE Works_On (
    SSN INT,
    ProjectNo INT,
    HoursPerWeek DECIMAL(4,1),
    PRIMARY KEY (SSN, ProjectNo),
    FOREIGN KEY (SSN) REFERENCES Employee(SSN),
    FOREIGN KEY (ProjectNo) REFERENCES Project(ProjectNo)
);

CREATE TABLE Dependent (
    SSN INT,
    DependentName VARCHAR(50),
    Sex CHAR(1),
    BirthDate DATE,
    Relationship VARCHAR(20),
    PRIMARY KEY (SSN, DependentName),
    FOREIGN KEY (SSN) REFERENCES Employee(SSN)
);


SELECT e.Name, d.DeptName, e.Salary
FROM Employee e
JOIN Department d ON e.DeptNo = d.DeptNo
WHERE e.Salary >
(
    SELECT AVG(Salary)
    FROM Employee
    WHERE DeptNo = (
        SELECT DeptNo
        FROM Department
        WHERE DeptName = 'Finance'
    )
);

SELECT e.Name, d.DeptName, COUNT(w.ProjectNo) AS NumberOfProjects
FROM Employee e
JOIN Works_On w ON e.SSN = w.SSN
JOIN Project p ON w.ProjectNo = p.ProjectNo
JOIN Department d ON e.DeptNo = d.DeptNo
WHERE p.DeptNo = (
        SELECT DeptNo 
        FROM Department 
        WHERE DeptName = 'IT'
)
GROUP BY e.SSN, e.Name, d.DeptName
HAVING COUNT(w.ProjectNo) > 2;


SELECT p.ProjectNo AS Project_ID,
       p.ProjectName AS Project_Title,
       d.DeptName,
       p.CompletionDate
FROM Project p
JOIN Department d ON p.DeptNo = d.DeptNo
WHERE p.CompletionDate > CURRENT_DATE;


SELECT s.SSN AS Supervisor_ID, s.Name AS Supervisor_Name
FROM Employee s
JOIN Employee e ON s.SSN = e.SupervisorSSN
JOIN Works_On w ON e.SSN = w.SSN
JOIN Project p ON w.ProjectNo = p.ProjectNo
WHERE p.CompletionDate IS NOT NULL
GROUP BY s.SSN, s.Name
HAVING COUNT(DISTINCT e.SSN) > 3;


SELECT e.SSN,
       e.Name,
       SUM(p.ProjectAmount) AS Total_Project_Amount,
       d.DependentName
FROM Employee e
JOIN Dependent d ON e.SSN = d.SSN
JOIN Works_On w ON e.SSN = w.SSN
JOIN Project p ON w.ProjectNo = p.ProjectNo
WHERE p.CompletionDate IS NOT NULL
GROUP BY e.SSN, e.Name, d.DependentName
HAVING SUM(p.ProjectAmount) >= 1000000;


SELECT DISTINCT
       e.SSN AS Employee_ID,
       e.DeptNo AS Department_ID,
       p.ProjectNo AS Project_ID,
       p.Location AS City
FROM Employee e
JOIN Works_On w ON e.SSN = w.SSN
JOIN Project p ON w.ProjectNo = p.ProjectNo
WHERE e.SSN IN
(
    SELECT w1.SSN
    FROM Works_On w1
    JOIN Project p1 ON w1.ProjectNo = p1.ProjectNo
    GROUP BY w1.SSN
    HAVING COUNT(DISTINCT p1.Location) > 1
);
